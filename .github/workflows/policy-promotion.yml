name: Policy Promotion

on:
  push:
    branches: ["main"]
    paths:
      - "cookbooks/sample_nginix/Policyfile.lock.json"
  workflow_dispatch:
    inputs:
      target_group:
        description: "Target policy group (stage or prod)"
        required: true
        default: "stage"
        type: choice
        options:
          - stage
          - prod

env:
  CHEF_LICENSE: accept-silent

concurrency:
  group: policy-promotion
  cancel-in-progress: false

jobs:
  push_test:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Chef Workstation
        run: |
          curl -L https://omnitruck.chef.io/install.sh | sudo bash -s -- -P chef-workstation -v 25.12.1102
          echo "/opt/chef-workstation/bin" >> $GITHUB_PATH

      - name: Configure Chef
        env:
          CHEF_SERVER_URL: ${{ secrets.CHEF_SERVER_URL }}
          CHEF_USER: ${{ secrets.CHEF_USER }}
          CHEF_USER_KEY: ${{ secrets.CHEF_USER_KEY }}
        run: |
          mkdir -p ~/.chef
          echo "${CHEF_USER_KEY}" > ~/.chef/ci-user.pem
          chmod 600 ~/.chef/ci-user.pem

          printf "[default]\nchef_server_url = %s\nclient_name = %s\nclient_key = %s\n" \
            "${CHEF_SERVER_URL}" \
            "${CHEF_USER}" \
            "/home/runner/.chef/ci-user.pem" \
            > ~/.chef/credentials

      - name: Install & Push to test
        working-directory: cookbooks/sample_nginix
        run: |
          set -e
          echo "Installing from Policyfile..."
          chef install
          echo "Pushing policy to test group..."
          chef push test
          echo "Policy pushed successfully!"

  promote:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Chef Workstation
        run: |
          curl -L https://omnitruck.chef.io/install.sh | sudo bash -s -- -P chef-workstation -v 25.12.1102
          echo "/opt/chef-workstation/bin" >> $GITHUB_PATH

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Configure Chef
        env:
          CHEF_SERVER_URL: ${{ secrets.CHEF_SERVER_URL }}
          CHEF_USER: ${{ secrets.CHEF_USER }}
          CHEF_USER_KEY: ${{ secrets.CHEF_USER_KEY }}
        run: |
          mkdir -p ~/.chef
          echo "${CHEF_USER_KEY}" > ~/.chef/ci-user.pem
          chmod 600 ~/.chef/ci-user.pem

          printf "[default]\nchef_server_url = %s\nclient_name = %s\nclient_key = %s\n" \
            "${CHEF_SERVER_URL}" \
            "${CHEF_USER}" \
            "/home/runner/.chef/ci-user.pem" \
            > ~/.chef/credentials

      - name: Debug - Check Policyfile
        working-directory: cookbooks/sample_nginix
        run: |
          set -e
          echo "=== Listing directory contents ==="
          ls -lh
          echo "=== Policyfile.lock.json exists ==="
          test -f Policyfile.lock.json && echo "✓ File exists" || echo "✗ File NOT found"
          echo "=== Extracting revision ==="
          cat Policyfile.lock.json | head -20

      - name: Promote to ${{ github.event.inputs.target_group }}
        working-directory: cookbooks/sample_nginix
        run: |
          set -e
          echo "Extracting revision from Policyfile.lock.json..."
          REVISION=$(jq -r '.revision_id' Policyfile.lock.json)
          
          if [ -z "$REVISION" ] || [ "$REVISION" = "null" ]; then
            echo "ERROR: Could not extract revision ID"
            exit 1
          fi
          
          echo "✓ Revision: $REVISION"
          echo "Promoting sample_nginx@$REVISION to ${{ github.event.inputs.target_group }}..."
          chef promote sample_nginx $REVISION ${{ github.event.inputs.target_group }}
          echo "✓ Promotion complete!"

      - name: Verify promotion
        working-directory: cookbooks/sample_nginix
        run: |
          echo "Verifying policy in ${{ github.event.inputs.target_group }} group..."
          knife show policy sample_nginx ${{ github.event.inputs.target_group }}
